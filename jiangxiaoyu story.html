<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="ahworld" />
        <meta name="copyright" content="ahworld" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="seurat ， scanpy, single-cell, " />

<meta property="og:title" content="僵小鱼的故事 "/>
<meta property="og:url" content="/jiangxiaoyu story.html" />
<meta property="og:description" content="许多年之后，面对同一个作图需求，僵小鱼准会回想起，在微信群里提出相同问题的那个遥远的上午" />
<meta property="og:site_name" content="seqyuan" />
<meta property="og:article:author" content="ahworld" />
<meta property="og:article:published_time" content="2020-01-15T00:00:00+08:00" />
<meta name="twitter:title" content="僵小鱼的故事 ">
<meta name="twitter:description" content="许多年之后，面对同一个作图需求，僵小鱼准会回想起，在微信群里提出相同问题的那个遥远的上午">

        <title>僵小鱼的故事  · seqyuan
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>seqyuan</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/jiangxiaoyu story.html"> 僵小鱼的故事  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <blockquote>
<p>许多年之后，面对同一个作图需求，僵小鱼将会回想起，在微信群里提出相同问题的那个遥远的上午</p>
</blockquote>
<p>在那个遥远的上午，百无聊赖的做着项目，用<a href="https://satijalab.org/seurat/pancreas_integration_label_transfer.html">Seurat</a>画着一个又一个单细胞marker基因小提琴图，“这种图真是够了！”，她在心里想着，“是时候该换一种风格了，最好能够把多个基因的小提琴图规则美观的合并在一起，这样就能直接用在文章里了”。</p>
<p><img alt="9296d89bf90fcffb1feb208444aeaba5.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_1.png"></p>
<p>果然在看过的顶级期刊文章里她找到了一个对胃口的图，“嗯，就是这个了”，想归想，真正要实现的时候发现：非常熟悉的Seurat不能直接产生这种图，“怎么办呢？”</p>
<p>“求助吧”，最近刚加了专业领域的微信群，群里大牛云集，“也许他们能给我点启发”，说着就试着发了自己的想法到群里。</p>
<p><img alt="b1c81aa36ab2e0e924d36897edf1fcbd.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_2.png"></p>
<p>对于群里的新成员，大家都还是比较热心的，有大佬直接指出“<code>scanpy does it</code>”，有的大佬指出“<code>这张图来自Nature肝硬化的文章吧</code>”，“都这么熟悉的么”，僵小鱼在群里回应道。“真的假的？”，吃瓜的我心里想着，然后默默打开搜索引擎，搜索“单细胞肝硬化”的新闻，找到原文“<a href="https://www.nature.com/articles/s41586-019-1631-3">Resolving the fibrotic niche of human liver cirrhosis at single-cell level</a>”，复制粘贴到sci-hub.tw，下载文章，这些都动作一气呵成，仿佛经历过多年的练习。果然，大佬诚不我欺，我从文章里找到了原图。</p>
<p><img alt="89e2163f81c51a19fb56c14fa1ab44cd.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_3.png"></p>
<p>群里继续有人在出主意：“Seurat+ppt就能搞定”，“ggplot is able to do everything”，“PPT+1”，“PS食用更佳”，“要么AI，要么AI”，“AI”，“AI ...”。最终僵小鱼选择了<code>AI</code>，以下是成图：</p>
<p><img alt="9d1239b17be9264db744ed0ae8a4404a.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_4.png"></p>
<blockquote>
<p><code>AI才是真的解决一切！</code></p>
</blockquote>
<p>僵小鱼的故事已经告一段落了，我的心里却久久未能平复，作为已经5年没向AI过低头的人，我始终秉承的信念是：<code>python能解决一切</code>。所以在僵小鱼声明“<code>我目前只能接受seurat</code>”后，众人不再理睬的那句“<code>scanpy does it</code>”始终萦绕在我的脑海。</p>
<p>scanpy是处理单细胞数据的python包，基本复现了seurat的主要功能，我曾经测试过，在处理大数据量的单细胞项目时，scanpy的速度和内存真是比seurat友好太多。今天再一次翻看了<a href="https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html">scanpy教程</a>，scanpy堆叠小提琴图的风格和Nature文章里的那个图很像，下面是scanpy教程里的小提琴图，在风格上还真是很像：</p>
<p><img alt="a402d4be69390fb1882ba97f979851a6.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_5.png"></p>
<p>但是怎样把seurat的对象转换成scanpy能够识别的数据格式呢，这一个是R S3对象，另一个是python的<a href="https://anndata.readthedocs.io/en/stable/api.html#module-anndata">anndata</a>对象。最初的想法是能不能把seurat对象的矩阵和分群信息导出到文件，再手动构建一个anndata对象，真要做的时候发现面临很多困难。</p>
<p>最终经过在google搜索，毫无意外的发现了同道中人，有相同需求的人在<code>bioinformatics</code>上提问<a href="https://bioinformatics.stackexchange.com/questions/3943/convert-r-rna-seq-data-object-to-a-python-object">Convert R RNA-seq data object to a Python object</a>，通过查看这个页面提供的方案，我发现<a href="https://satijalab.org/seurat/v3.1/conversion_vignette.html">seurat官网</a>提供了不同单细胞处理软件结果互通的转换方法。</p>
<p><img alt="98691e781a906e3bf1774ce4a55e9f63.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_6.png"></p>
<p>seurat官网提供了<code>seurat对象</code>与<code>SingleCellExperiment</code>、<code>loom</code>、<code>AnnData</code>三种单细胞数据格式相互转换的方法。目前seurat（version 3.1）不支持写入scanpy要求的H5AD文件，所以目前的解决方案是：</p>
<ol>
<li>Seurat对象转换为loom文件</li>
<li>Scanpy读取loom文件转换为能够操作的anndata对象</li>
</ol>
<p>要是实现上面的两个简单的步骤还需要安装一些R和python包，需要安装的有以下几个，如果已经安装了，忽略就好：</p>
<ul>
<li>R包：<a href="https://satijalab.org/seurat/install.html">seurat</a></li>
<li>R包：<a href="https://github.com/hhoeflin/hdf5r">hdf5r</a></li>
<li>R包：<a href="https://satijalab.org/loomR/loomR_tutorial.html">loomR</a></li>
<li>R包：<a href="https://bioconductor.org/packages/release/bioc/html/scater.html">scater</a></li>
<li>python包：<a href="https://scanpy.readthedocs.io/en/stable/installation.html">scanpy</a></li>
<li>python包：<a href="http://linnarssonlab.org/loompy/installation/index.html">loompy</a></li>
</ul>
<blockquote>
<p>安装好以上包之后，<em><code>在R中执行以下代码</code></em> ，实现第一步：<code>Seurat对象转换为loom文件</code></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">#读入seurat处理后的rds文件</span>
<span class="nf">library</span><span class="p">(</span><span class="n">Seurat</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">loomR</span><span class="p">)</span>

<span class="n">sdata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/yuanzan/Desktop/tmp/seurat_project.rds&quot;</span><span class="p">)</span>
<span class="c1"># seurat对象转换为loop文件</span>
<span class="n">sdata.loom</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.loom</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdata</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/yuanzan/Desktop/tmp/sdata.loom&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="c1"># Always remember to close loom files when done</span>
<span class="n">sdata.loom</span><span class="o">$</span><span class="nf">close_all</span><span class="p">()</span>
</code></pre></div>

<blockquote>
<p>接着 <em><code>在jupyter中执行以下代码</code></em> ，实现第二步：<code>Scanpy读取loom文件转换为能够操作的anndata对象</code></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_loom</span><span class="p">(</span><span class="s2">&quot;/Users/yuanzan/Desktop/tmp/sdata.loom&quot;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">X_name</span><span class="o">=</span><span class="s1">&#39;spliced&#39;</span><span class="p">,</span> <span class="n">obs_names</span><span class="o">=</span><span class="s1">&#39;CellID&#39;</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

<span class="n">marker_genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Stfa1&#39;</span><span class="p">,</span> <span class="s1">&#39;Ngp&#39;</span><span class="p">,</span> <span class="s1">&#39;Ccl5&#39;</span><span class="p">,</span> <span class="s1">&#39;Ccl4&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100530&#39;</span><span class="p">,</span> <span class="s1">&#39;Gzma&#39;</span><span class="p">,</span> <span class="s1">&#39;Gata2&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd74&#39;</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">stacked_violin</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">marker_genes</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ClusterName&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</code></pre></div>

<p>初步产生的图和scanpy教程里一样，挑选的marker基因在各个亚群中的表达小提琴图，规则的排布在了一起，基本实现了当初的想法。</p>
<p><img alt="4d2b58a4c8f94ba6f2acf69477bfc4b2.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_7.png"></p>
<p>再调一下参数，转换X轴和Y轴标签：</p>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">stacked_violin</span><span class="p">(</span><span class="n">sdata</span><span class="p">,</span> <span class="n">marker_genes</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ClusterName&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">swap_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="s2">&quot;_tmp.png&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="91c7fc5e195e3fb0b29ce0d891ca9dca.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_8.png"></p>
<p>到这里和文章里的图只差顺时针旋转90度了，于是查看了scanpy的源代码，发现是一个叫<code>stacked_violin</code>的函数调用的<code>seaborn.violinplot</code>实现的这个小提琴图，那我就copy一下这个函数，修改一些设置，让其由纵向增加小提琴图变为横向增加小提琴图就可以了。转念又一想还是不浪费时间了，“<code>用AI吧，简单操作一下就能搞定了</code>”，不知道从哪里冒出一个声音，真是可恶，那就用代码简单实现一下旋转吧：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;./figures/stacked_violin_tmp.png&#39;</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_270</span><span class="p">)</span>
</code></pre></div>

<p><img alt="9ad9428dec37767f78607bbc743fc123.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/jiangxiaoyu_9.png"></p>
<p>多年以后，再次读起这些文字，我一定会回想起此时自己没等看到最后一行便已明白，自己不会再走出这故事。从一个围观的吃瓜群众到讲述这个故事再到成为故事一部分的我，应该很庆幸此时的参与。一切过往自永远至永远不会再重复，因为激发起相同兴趣的情形不会有第二次机会在大地上出现。</p>
<p>欢迎扫码关注生信微信公众号</p>
<p><img alt="seqyuan" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/jiangxiaoyu/seqyuan.jpg"></p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4><a href="/author/ahworld.html"> <i class="icon-user"></i>ahworld</a></h4>

            <!--<h4>Published</h4>-->
			<h4><time pubdate="pubdate" datetime="2020-01-15T00:00:00+08:00"><i class="icon-calendar"></i>2020-01-15</time></h4>

            <h4><i class="icon-folder-open"></i>Category</h4>
            <a class="category-link" href="/categories.html#single-cell-ref">single-cell</a>
            <h4><i class="icon-tag"></i>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#seurat-scanpy-ref">seurat ， scanpy
                    <span>1</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Designed by <a href="http://www.seqyuan.com/" title="Seqyuan Home Page">Yuan Zan</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>