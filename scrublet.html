<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="ahworld" />
        <meta name="copyright" content="ahworld" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="QC, singcell, " />

<meta property="og:title" content="单细胞数据质控-双细胞预测-scrublet使用教程 "/>
<meta property="og:url" content="/scrublet.html" />
<meta property="og:description" content="单细胞数据质控-双细胞预测-scrublet使用教程" />
<meta property="og:site_name" content="seqyuan" />
<meta property="og:article:author" content="ahworld" />
<meta property="og:article:published_time" content="2020-04-13T00:00:00+08:00" />
<meta name="twitter:title" content="单细胞数据质控-双细胞预测-scrublet使用教程 ">
<meta name="twitter:description" content="单细胞数据质控-双细胞预测-scrublet使用教程">

        <title>单细胞数据质控-双细胞预测-scrublet使用教程  · seqyuan
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>seqyuan</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/scrublet.html"> 单细胞数据质控-双细胞预测-scrublet使用教程  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>在分析scRNA-seq数据之前，我们必须确保所有细胞barcode均与活细胞相对应。通常基于三个QC协变量执行细胞QC（Quality control）：</p>
<ol>
<li>每个barcode的数量</li>
<li>每个barcode对应的基因数量</li>
<li>每个barcode的数量中线粒体基因的占比</li>
</ol>
<p>通过这些QC协变量的分布图，可以通过阈值过滤掉离群峰。</p>
<p><img alt="scrublet_01.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scrublet/scrublet_01.png"></p>
<p>这些异常的barcodes对应着：</p>
<ul>
<li>死细胞</li>
<li>细胞膜破损的细胞</li>
<li>双细胞(doublets)</li>
</ul>
<p>例如，barcodes计数深度低，检测到的基因很少且线粒体计数高，这表明细胞的细胞质mRNA已通过破膜渗出，因此，仅位于线粒体中的mRNA仍然在细胞内。相反，具有非预期高计数和检测到大量基因的细胞可能代表双细胞。 </p>
<p>检测scRNA-seq中双细胞的分析鉴定工具总结了以下几种：</p>
<ul>
<li><a href="https://github.com/AllonKleinLab/scrublet">scrublet</a> (python)</li>
<li><a href="https://github.com/JonathanShor/DoubletDetection">DoubletDetection</a> (python)</li>
<li><a href="https://github.com/EDePasquale/DoubletDecon">DoubletDecon</a> (R)</li>
<li><a href="https://github.com/chris-mcginnis-ucsf/DoubletFinder">DoubletFinder</a> (R)</li>
</ul>
<p>这些双细胞的分析鉴定工具在2019年发表的《单细胞数据分析最佳实践》中也有推荐(<a href="https://www.embopress.org/doi/full/10.15252/msb.20188746">Luecken M D et al, 2019</a>)</p>
<blockquote>
<p><strong>本期将对<code>scrublet</code>的使用做一个详细介绍</strong></p>
</blockquote>
<h2>scrublet的使用</h2>
<p><strong>scrublet文献</strong>:Wolock S L, Lopez R, Klein A M. Scrublet: computational identification of cell doublets in single-cell transcriptomic data[J]. Cell systems, 2019, 8(4): 281-291. e9.
<a href="https://github.com/AllonKleinLab/scrublet/blob/master/examples/scrublet_basics.ipynb">scrublet教程参考来源链接</a></p>
<h3>安装</h3>
<p>scrublet为python语言编写的包，用以下pip命令安装就可以。</p>
<div class="highlight"><pre><span></span><code>pip install scrublet
</code></pre></div>

<h3>使用注意事项</h3>
<ul>
<li><code>处理来自多个样本的数据时，请分别对每个样本运行Scrublet</code>。 因为Scrublet旨在检测由两个细胞的随机共封装形成的technical doublets，所以在merged数据集上可能会表现不佳，因为细胞类型比例不代表任何单个样品；</li>
<li><code>检查doublet score阈值是否合理</code>，并在必要时进行手动调整。并不是所有情况向下doublet score的直方分布图都是呈现标准的双峰；</li>
<li><code>UMAP或t-SNE可视化的结果中，预测的双细胞应该大体上共定位（可能在多个细胞群中）</code>。 如果不是，则可能需要调整doublet score阈值，或更改预处理参数以更好地解析数据中存在的细胞状态。</li>
</ul>
<h3>准备工作</h3>
<h4>数据准备</h4>
<p>下载来自<a href="http://cf.10xgenomics.com/samples/cell-exp/2.1.0/pbmc8k/pbmc8k_filtered_gene_bc_matrices.tar.gz">10X Genomics8k的PBMC数据集</a>并解压。</p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>http://cf.10xgenomics.com/samples/cell-exp/2.1.0/pbmc8k/pbmc8k_filtered_gene_bc_matrices.tar.gz
tar<span class="w"> </span>xfz<span class="w"> </span>pbmc8k_filtered_gene_bc_matrices.tar.gz
</code></pre></div>

<h4>numpy兼容性报错修复</h4>
<p>高版本numpy带来的<code>cannot import name '_validate_lenghs'</code>报错修复方案</p>
<p><code>scrublet</code>包的开发依赖的是比较低版本的numpy，会用到<code>arraypad.py</code>中的<a href="https://www.cnblogs.com/lixiansheng/p/10293323.html">_validate_lenghs</a>函数，这个函数在比较高的numpy版本中已经弃用，如果安装的是高版本numpy，可能在运行scrublet时会有报错导致中断：<code>cannot import name '_validate_lenghs'</code>。</p>
<p>考虑到一般其他软件包依赖高版本numpy的情况比较多，不想再降低numpy的版本，所以让scrublet能够运行下去的修复方案为如下：</p>
<p>打开终端，进入Python环境，输入以下代码，查看Python安装位置。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

<p>找到arraypad.py的位置 ~/anaconda3/lib/python3.6/site-packages/numpy/lib/arraypad.py，打开文件，在文件最后添加以下代码，保存退出，问题解决。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_normalize_shape</span><span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">cast_to_int</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private function which does some checks and normalizes the possibly</span>
<span class="sd">    much simpler representations of ‘pad_width‘, ‘stat_length‘,</span>
<span class="sd">    ‘constant_values‘, ‘end_values‘.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    narray : ndarray</span>
<span class="sd">        Input ndarray</span>
<span class="sd">    shape : {sequence, array_like, float, int}, optional</span>
<span class="sd">        The width of padding (pad_width), the number of elements on the</span>
<span class="sd">        edge of the narray used for statistics (stat_length), the constant</span>
<span class="sd">        value(s) to use when filling padded regions (constant_values), or the</span>
<span class="sd">        endpoint target(s) for linear ramps (end_values).</span>
<span class="sd">        ((before_1, after_1), ... (before_N, after_N)) unique number of</span>
<span class="sd">        elements for each axis where `N` is rank of `narray`.</span>
<span class="sd">        ((before, after),) yields same before and after constants for each</span>
<span class="sd">        axis.</span>
<span class="sd">        (constant,) or val is a shortcut for before = after = constant for</span>
<span class="sd">        all axes.</span>
<span class="sd">    cast_to_int : bool, optional</span>
<span class="sd">        Controls if values in ``shape`` will be rounded and cast to int</span>
<span class="sd">        before being returned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    normalized_shape : tuple of tuples</span>
<span class="sd">        val                               =&gt; ((val, val), (val, val), ...)</span>
<span class="sd">        [[val1, val2], [val3, val4], ...] =&gt; ((val1, val2), (val3, val4), ...)</span>
<span class="sd">        ((val1, val2), (val3, val4), ...) =&gt; no change</span>
<span class="sd">        [[val1, val2], ]                  =&gt; ((val1, val2), (val1, val2), ...)</span>
<span class="sd">        ((val1, val2), )                  =&gt; ((val1, val2), (val1, val2), ...)</span>
<span class="sd">        [[val ,     ], ]                  =&gt; ((val, val), (val, val), ...)</span>
<span class="sd">        ((val ,     ), )                  =&gt; ((val, val), (val, val), ...)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndims</span> <span class="o">=</span> <span class="n">ndarray</span><span class="o">.</span><span class="n">ndim</span>

    <span class="c1"># Shortcut shape=None</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ndims</span>

    <span class="c1"># Convert any input `info` to a NumPy array</span>
    <span class="n">shape_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shape_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">shape_arr</span><span class="p">,</span> <span class="p">(</span><span class="n">ndims</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;Unable to create correctly shaped tuple from </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">shape</span><span class="p">,))</span>

    <span class="c1"># Cast if necessary</span>
    <span class="k">if</span> <span class="n">cast_to_int</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">shape_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shape_arr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Convert list of lists to tuple of tuples</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">shape_arr</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_validate_lengths</span><span class="p">(</span><span class="n">narray</span><span class="p">,</span> <span class="n">number_elements</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private function which does some checks and reformats pad_width and</span>
<span class="sd">    stat_length using _normalize_shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    narray : ndarray</span>
<span class="sd">        Input ndarray</span>
<span class="sd">    number_elements : {sequence, int}, optional</span>
<span class="sd">        The width of padding (pad_width) or the number of elements on the edge</span>
<span class="sd">        of the narray used for statistics (stat_length).</span>
<span class="sd">        ((before_1, after_1), ... (before_N, after_N)) unique number of</span>
<span class="sd">        elements for each axis.</span>
<span class="sd">        ((before, after),) yields same before and after constants for each</span>
<span class="sd">        axis.</span>
<span class="sd">        (constant,) or int is a shortcut for before = after = constant for all</span>
<span class="sd">        axes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _validate_lengths : tuple of tuples</span>
<span class="sd">        int                               =&gt; ((int, int), (int, int), ...)</span>
<span class="sd">        [[int1, int2], [int3, int4], ...] =&gt; ((int1, int2), (int3, int4), ...)</span>
<span class="sd">        ((int1, int2), (int3, int4), ...) =&gt; no change</span>
<span class="sd">        [[int1, int2], ]                  =&gt; ((int1, int2), (int1, int2), ...)</span>
<span class="sd">        ((int1, int2), )                  =&gt; ((int1, int2), (int1, int2), ...)</span>
<span class="sd">        [[int ,     ], ]                  =&gt; ((int, int), (int, int), ...)</span>
<span class="sd">        ((int ,     ), )                  =&gt; ((int, int), (int, int), ...)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normshp</span> <span class="o">=</span> <span class="n">_normalize_shape</span><span class="p">(</span><span class="n">narray</span><span class="p">,</span> <span class="n">number_elements</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">normshp</span><span class="p">:</span>
        <span class="n">chk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">chk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chk</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">chk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> cannot contain negative values.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">number_elements</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">normshp</span>
</code></pre></div>

<h3>scrublet使用教程</h3>
<p><img alt="scrublet_02.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scrublet/scrublet_02.png"></p>
<p>我的测试执行环境是MACOS jupyter notebook，以下代码为python包的载入和画图设置：</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">scrublet</span> <span class="k">as</span> <span class="nn">scr</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sans-serif&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Arial&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
</code></pre></div>

<p>读入10X的scRNA-seq矩阵，读入raw counts矩阵为scipy sparse矩阵，cells作为行，genes作为列：</p>
<div class="highlight"><pre><span></span><code><span class="n">input_dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/yuanzan/Desktop/doublets/filtered_gene_bc_matrices/GRCh38/&#39;</span>
<span class="n">counts_matrix</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s1">&#39;/matrix.mtx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
<span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scr</span><span class="o">.</span><span class="n">load_genes</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s1">&#39;/genes.tsv&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s1">&#39;/barcodes.tsv&#39;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;barcode&#39;</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Counts matrix shape: </span><span class="si">{}</span><span class="s1"> rows, </span><span class="si">{}</span><span class="s1"> columns&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counts_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">counts_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of genes in gene list: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">)))</span>
</code></pre></div>

<p>Counts matrix shape: 8381 rows, 33694 columns
Number of genes in gene list: 33694</p>
<h5>初始化Scrublet对象</h5>
<p>相关参数为：
* <code>expected_doublet_rate</code>，doublets的预期占比，通常为0.05-0.1，结果对该参数不是特别敏感。 对于此示例数据，预期的doublets占比来自<a href="https://support.10xgenomics.com/permalink/3vzDu3zQjY0o2AqkkkI4CC">Chromium用户指南</a>
* <code>sim_doublet_ratio</code>，要模拟的doublets数量相对于转录组的观测值的比例。此值应该足够高，以使所有的doublet状态都能很好地由模拟doublets表示。设置得太高会使计算量增大，默认值是2（尽管设置低至0.5的值也对测试的数据集产生非常相似的结果。
* <code>n_neighbors</code>，用于构造转录组观测值和模拟doublets的KNN分类器的邻居数。 默认值为round（0.5 * sqrt（n_cells）），通常表现比较好。</p>
<div class="highlight"><pre><span></span><code><span class="n">scrub</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">Scrublet</span><span class="p">(</span><span class="n">counts_matrix</span><span class="p">,</span> <span class="n">expected_doublet_rate</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>
</code></pre></div>

<h5>计算doublet score</h5>
<p>运行下面的代码计算doublet score，内部处理过程包括:</p>
<ol>
<li>Doublet simulation</li>
<li>Normalization, gene filtering, rescaling, PCA</li>
<li>Doublet score calculation</li>
<li>Doublet score threshold detection and doublet calling</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">doublet_scores</span><span class="p">,</span> <span class="n">predicted_doublets</span> <span class="o">=</span> <span class="n">scrub</span><span class="o">.</span><span class="n">scrub_doublets</span><span class="p">(</span><span class="n">min_counts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_gene_variability_pctl</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">n_prin_comps</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</code></pre></div>

<p><img alt="scrublet_03.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scrublet/scrublet_03.png"></p>
<h5>绘制doublet score分布直方图</h5>
<p>Doublet score分布直方图包括观察到的转录组和模拟的doublet，模拟的doublet直方图通常是双峰的。</p>
<ul>
<li>下面<code>左图模式</code>对应于由具有相似基因表达的两个细胞产生的"embedded" doublets；</li>
<li><code>右图模式</code>对应"neotypic" doublets，由具有不同基因表达的细胞（例如，不同类型的细胞）产生，这些会在下游分析中引入更多的假象。<code>Scrublet只能检测"neotypic" doublets</code>。</li>
</ul>
<p>要call doublets vs. singlets，我们必须设置一个doublet score阈值，理想情况下，阈值应在模拟doublet直方图的两种模式之间设置最小值。<code>scrub_doublets()</code>函数尝试自动识别这一点，在这个测试数据示例中表现比较好。如果自动阈值检测效果不佳，则可以使用<code>call_doublets()</code>函数调整阈值，例如：</p>
<div class="highlight"><pre><span></span><code><span class="n">scrub</span><span class="o">.</span><span class="n">call_doublets</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># 画doublet score直方图</span>
<span class="n">scrub</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">()</span>
</code></pre></div>

<p><img alt="scrublet_04.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scrublet/scrublet_04.png"></p>
<h5>降维可视化</h5>
<h6>降维计算</h6>
<p>这个示例采用UMAP降维，还有tSNE可选，作者不推荐用tSNE，因为运行比较慢。</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running UMAP...&#39;</span><span class="p">)</span>
<span class="n">scrub</span><span class="o">.</span><span class="n">set_embedding</span><span class="p">(</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span> <span class="n">scr</span><span class="o">.</span><span class="n">get_umap</span><span class="p">(</span><span class="n">scrub</span><span class="o">.</span><span class="n">manifold_obs_</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
</code></pre></div>

<h6>UMAP可视化</h6>
<div class="highlight"><pre><span></span><code><span class="n">scrub</span><span class="o">.</span><span class="n">plot_embedding</span><span class="p">(</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span> <span class="n">order_points</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>下面左图黑色的点为预测的doublets。</p>
<p><img alt="scrublet_05.png" src="https://raw.githubusercontent.com/seqyuan/blog/master/images/scrublet/scrublet_05.png"></p>
<div class="highlight"><pre><span></span><code><span class="c1"># doublets占比</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">scrub</span><span class="o">.</span><span class="n">detected_doublet_rate_</span><span class="p">)</span>
<span class="c1"># 0.043789523923159525</span>
</code></pre></div>

<p>把doublets预测结果保存到文件，后续用Seurat等软件处理的时候可以导入doublets的预测结果对barcode进行筛选。</p>
<div class="highlight"><pre><span></span><code><span class="n">out_df</span><span class="p">[</span><span class="s1">&#39;doublet_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doublet_scores</span>
<span class="n">out_df</span><span class="p">[</span><span class="s1">&#39;predicted_doublets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_doublets</span>
<span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">input_dir</span> <span class="o">+</span> <span class="s1">&#39;/doublet.txt&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

<table>
<thead>
<tr>
<th>barcode</th>
<th>doublet_scores</th>
<th>predicted_doublets</th>
</tr>
</thead>
<tbody>
<tr>
<td>AAACCTGAGCATCATC-1</td>
<td>0.020232985898221900</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGAGCTAACTC-1</td>
<td>0.009746972531259230</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGAGCTAGTGG-1</td>
<td>0.013493253373313300</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGCACATTAGC-1</td>
<td>0.087378640776699</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGCACTGTTAG-1</td>
<td>0.02405046655276650</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGCATAGTAAG-1</td>
<td>0.03969184391224250</td>
<td>FALSE</td>
</tr>
<tr>
<td>AAACCTGCATGAACCT-1</td>
<td>0.030082836796977200</td>
<td>FALSE</td>
</tr>
</tbody>
</table>
<p>此次测试的jupyter notebook上传到了我的github-<a href="https://github.com/seqyuan/blog/blob/master/images/scrublet/scrublet_basics.ipynb">seqyuan</a>，有需要可以下载测试。</p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4><a href="/author/ahworld.html"> <i class="icon-user"></i>ahworld</a></h4>

            <!--<h4>Published</h4>-->
			<h4><time pubdate="pubdate" datetime="2020-04-13T00:00:00+08:00"><i class="icon-calendar"></i>2020-04-13</time></h4>

            <h4><i class="icon-folder-open"></i>Category</h4>
            <a class="category-link" href="/categories.html#singcell-ref">singcell</a>
            <h4><i class="icon-tag"></i>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#qc-ref">QC
                    <span>1</span>
</a></li>
            </ul>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Designed by <a href="http://www.seqyuan.com/" title="Seqyuan Home Page">Yuan Zan</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>